fits$dat$data$Missing <- as.character(fits$dat$data$Missing)
years_to_include <- fits$dat$data %>%
filter(Year != 1980, HIV.p > 0, Site != "Imputed Site") %>%
select(Year, Missing) %>% unique
predicted <- map_df(fits$fits, function(fit){
imputed <- fit$fit$summary.fitted.values[, c("mean", "0.025quant", "0.975quant")] %>%
cbind(fits$dat$data[,c("Missing",  "Year")]) %>%
filter(imputed_idx)
mix <- imputed %>%
full_join(missing_weights, by = c("Missing")) %>%
mutate(p_mean = p_sites * mean
)  %>% select(Year, Missing, p_mean)
mix_mean <- mix %>%
right_join(years_to_include, by = c("Year", "Missing")) %>%
spread(Missing, p_mean) %>%
mutate(
mean = apply(.[,2:ncol(.)], 1, function(pmeans){
if (sum(!is.na(pmeans)) <= 1){
return(NA)
}   else {
sum(pmeans, na.rm = T)
}
}),
model = fit$model
)
a <- inla.posterior.sample(result = fit$fit, n = 1000)
samples <- map_df(a, function(a){
fits$dat$data[,c("Missing", "Year")] %>%
cbind(prev = exp(a$latent[1:nrow(.)])/(exp(a$latent[1:nrow(.)]) + 1)) %>%
filter(imputed_idx)
}) %>%
full_join(missing_weights, by = "Missing") %>%
mutate(sampleno = rep(1:1000, each = sum(imputed_idx)),
p_mean = p_sites * prev) %>%
select(-prev, -n_sites, -p_sites) %>%
right_join(years_to_include, by = c("Year", "Missing"))
b <- samples %>% spread(Missing, p_mean) %>%
mutate(mean_mix = apply(.[,3:ncol(.)], 1, function(pmeans){
if (sum(!is.na(pmeans)) <= 1){
return(NA)
}   else {
sum(pmeans, na.rm = T)
}
})) %>%
group_by(Year) %>%
nest() %>%
mutate(
cdf = map(data, function(d) {
if (is.na(d$mean_mix[1])) return(NA)
ecdf(d$mean_mix)
}),
lower = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.025)
}),
upper = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.975)
}),
lower2 = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.05)
}),
upper2 = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.95)
})) %>%
unnest(upper, lower) %>%
select(Year, upper, lower, upper2, lower2) %>%
full_join(mix_mean)
})
estimates <- map_df(fits$fits, function(f){
f$fit$summary.fitted.values[, c("mean", "0.025quant", "0.975quant")] %>%
cbind(fits$dat$data[,c("Missing",  "Year")]) %>%
filter(imputed_idx) %>%
select(Missing, Year, mean) %>%
mutate(model = f$model)
}) %>%
right_join(years_to_include, by = c("Year", "Missing"))
p <- ggplot(fits$dat$data, aes(x = Year)) +
geom_point(aes(y = prev, color = Missing), alpha = 0.5) +
geom_line(data = estimates, aes(y = mean, color = Missing)) +
geom_line(data = predicted, aes(y = mean)) +
facet_wrap(~model) +
geom_ribbon(data = predicted, aes(ymin = lower, ymax = upper),
alpha = 0.2) +
geom_ribbon(data = predicted, aes(ymin = lower2, ymax = upper2),
alpha = 0.2) +
theme_minimal() +
labs(title = "Prediction for new site")
return(list(plot = p, table = missing_weights))
}
name <- "Botswana"
df <- print_comparison_df(name)
zeros = T
modeldf <- df$df
fits <- run_fits(name, modeldf, zeros)
fits <- run_fits(name, modeldf, zeros)
imputed_idx <- fits$dat$data$Site == "Imputed Site"
missing_weights <- fits$dat$data %>%
filter(Site != "Imputed Site") %>%
group_by(Missing) %>%
summarise(n_sites = Site %>% unique %>% length) %>%
# summarise(n_sites = n()) %>%
ungroup() %>%
mutate(p_sites = n_sites/sum(n_sites),
Missing = as.character(Missing))
fits$dat$data$Missing <- as.character(fits$dat$data$Missing)
years_to_include <- fits$dat$data %>%
filter(Year != 1980, HIV.p > 0, Site != "Imputed Site") %>%
select(Year, Missing) %>% unique
missing_weights <- fits$dat$data %>%
filter(Site != "Imputed Site") %>%
group_by(Missing) %>%
summarise(
n_sites = Site %>% unique %>% length,
mean_size = mean(size)) %>%
# summarise(n_sites = n()) %>%
ungroup() %>%
mutate(p_sites = n_sites/sum(n_sites),
Missing = as.character(Missing))
fit <- fits$fits[[1]]
imputed <- fit$fit$summary.fitted.values[, c("mean", "0.025quant", "0.975quant")] %>%
cbind(fits$dat$data[,c("Missing",  "Year")]) %>%
filter(imputed_idx)
mix <- imputed %>%
full_join(missing_weights, by = c("Missing")) %>%
mutate(p_mean = p_sites * mean
)  %>% select(Year, Missing, p_mean)
mix_mean <- mix %>%
right_join(years_to_include, by = c("Year", "Missing")) %>%
spread(Missing, p_mean) %>%
mutate(
mean = apply(.[,2:ncol(.)], 1, function(pmeans){
if (sum(!is.na(pmeans)) <= 1){
return(NA)
}   else {
sum(pmeans, na.rm = T)
}
}),
model = fit$model
)
a <- inla.posterior.sample(result = fit$fit, n = 1000)
samples <- map_df(a, function(a){
fits$dat$data[,c("Missing", "Year")] %>%
cbind(prev = exp(a$latent[1:nrow(.)])/(exp(a$latent[1:nrow(.)]) + 1)) %>%
filter(imputed_idx)
}) %>%
full_join(missing_weights, by = "Missing") %>%
mutate(sampleno = rep(1:1000, each = sum(imputed_idx)),
p_mean = p_sites * prev)
View(samples)
missing_weights <- fits$dat$data %>%
filter(Site != "Imputed Site") %>%
group_by(Missing) %>%
summarise(
n_sites = Site %>% unique %>% length,
mean_size = mean(size, na.rm = T)) %>%
# summarise(n_sites = n()) %>%
ungroup() %>%
mutate(p_sites = n_sites/sum(n_sites),
Missing = as.character(Missing))
samples <- map_df(a, function(a){
fits$dat$data[,c("Missing", "Year")] %>%
cbind(prev = exp(a$latent[1:nrow(.)])/(exp(a$latent[1:nrow(.)]) + 1)) %>%
filter(imputed_idx)
}) %>%
full_join(missing_weights, by = "Missing") %>%
mutate(sampleno = rep(1:1000, each = sum(imputed_idx)),
p_mean = p_sites * prev)
missing_weights <- fits$dat$data %>%
filter(Site != "Imputed Site") %>%
group_by(Missing) %>%
summarise(
n_sites = Site %>% unique %>% length,
mean_size = mean(size, na.rm = T) %>% round) %>%
# summarise(n_sites = n()) %>%
ungroup() %>%
mutate(p_sites = n_sites/sum(n_sites),
Missing = as.character(Missing))
samples <- map_df(a, function(a){
fits$dat$data[,c("Missing", "Year")] %>%
cbind(prev = exp(a$latent[1:nrow(.)])/(exp(a$latent[1:nrow(.)]) + 1)) %>%
filter(imputed_idx)
}) %>%
full_join(missing_weights, by = "Missing") %>%
mutate(sampleno = rep(1:1000, each = sum(imputed_idx)),
p_mean = p_sites * prev)
?rbinom
rbinom(449, 449, 0.08409441) %>% View
rbinom(449, 449, 0.08409441) %>% View %>% sum() %>% `/`(449)
rbinom(449, 449, 0.08409441) %>% sum() %>% `/`(449)
rbinom(449, 449, 0.08409441) %>% sum()
rbinom(1, 449, 0.08409441)
samples <- map_df(a, function(a){
fits$dat$data[,c("Missing", "Year")] %>%
cbind(prev = exp(a$latent[1:nrow(.)])/(exp(a$latent[1:nrow(.)]) + 1)) %>%
filter(imputed_idx)
}) %>%
full_join(missing_weights, by = "Missing") %>%
mutate(
sampleno = rep(1:1000, each = sum(imputed_idx)),
sample_prev = map2_dbl(mean_size, prev, function(size, prev) {
rbinom(1, size, prev)/size
}
))
samples <- map_df(a, function(a){
fits$dat$data[,c("Missing", "Year")] %>%
cbind(prev = exp(a$latent[1:nrow(.)])/(exp(a$latent[1:nrow(.)]) + 1)) %>%
filter(imputed_idx)
}) %>%
full_join(missing_weights, by = "Missing") %>%
mutate(
sampleno = rep(1:1000, each = sum(imputed_idx)),
sample_prev = map2_dbl(mean_size, prev, function(size, prev) {
rbinom(1, size, prev)/size
}),
p_mean = p_sites * sample_prev
) %>%
select(-prev, -n_sites, -p_sites, - sample_prev) %>%
right_join(years_to_include, by = c("Year", "Missing"))
b <- samples %>% spread(Missing, p_mean) %>%
mutate(mean_mix = apply(.[,3:ncol(.)], 1, function(pmeans){
if (sum(!is.na(pmeans)) <= 1){
return(NA)
}   else {
sum(pmeans, na.rm = T)
}
}))
View(b)
samples <- map_df(a, function(a){
fits$dat$data[,c("Missing", "Year")] %>%
cbind(prev = exp(a$latent[1:nrow(.)])/(exp(a$latent[1:nrow(.)]) + 1)) %>%
filter(imputed_idx)
}) %>%
full_join(missing_weights, by = "Missing") %>%
mutate(
sampleno = rep(1:1000, each = sum(imputed_idx)),
sample_prev = map2_dbl(mean_size, prev, function(size, prev) {
rbinom(1, size, prev)/size
}),
p_mean = p_sites * sample_prev
) %>%
select(-prev, -n_sites, -p_sites, - sample_prev, -mean_size) %>%
right_join(years_to_include, by = c("Year", "Missing"))
b <- samples %>% spread(Missing, p_mean) %>%
mutate(mean_mix = apply(.[,3:ncol(.)], 1, function(pmeans){
if (sum(!is.na(pmeans)) <= 1){
return(NA)
}   else {
sum(pmeans, na.rm = T)
}
}))
predicted <- map_df(fits$fits, function(fit){
imputed <- fit$fit$summary.fitted.values[, c("mean", "0.025quant", "0.975quant")] %>%
cbind(fits$dat$data[,c("Missing",  "Year")]) %>%
filter(imputed_idx)
mix <- imputed %>%
full_join(missing_weights, by = c("Missing")) %>%
mutate(p_mean = p_sites * mean
)  %>% select(Year, Missing, p_mean)
mix_mean <- mix %>%
right_join(years_to_include, by = c("Year", "Missing")) %>%
spread(Missing, p_mean) %>%
mutate(
mean = apply(.[,2:ncol(.)], 1, function(pmeans){
if (sum(!is.na(pmeans)) <= 1){
return(NA)
}   else {
sum(pmeans, na.rm = T)
}
}),
model = fit$model
)
a <- inla.posterior.sample(result = fit$fit, n = 1000)
samples <- map_df(a, function(a){
fits$dat$data[,c("Missing", "Year")] %>%
cbind(prev = exp(a$latent[1:nrow(.)])/(exp(a$latent[1:nrow(.)]) + 1)) %>%
filter(imputed_idx)
}) %>%
full_join(missing_weights, by = "Missing") %>%
mutate(
sampleno = rep(1:1000, each = sum(imputed_idx)),
sample_prev = map2_dbl(mean_size, prev, function(size, prev) {
rbinom(1, size, prev)/size
}),
p_mean = p_sites * sample_prev
) %>%
select(-prev, -n_sites, -p_sites, - sample_prev, -mean_size) %>%
right_join(years_to_include, by = c("Year", "Missing"))
b <- samples %>% spread(Missing, p_mean) %>%
mutate(mean_mix = apply(.[,3:ncol(.)], 1, function(pmeans){
if (sum(!is.na(pmeans)) <= 1){
return(NA)
}   else {
sum(pmeans, na.rm = T)
}
})) %>%
group_by(Year) %>%
nest() %>%
mutate(
cdf = map(data, function(d) {
if (is.na(d$mean_mix[1])) return(NA)
ecdf(d$mean_mix)
}),
lower = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.025)
}),
upper = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.975)
}),
lower2 = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.05)
}),
upper2 = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.95)
})) %>%
unnest(upper, lower) %>%
select(Year, upper, lower, upper2, lower2) %>%
full_join(mix_mean)
})
predicted <- map_df(fits$fits, function(fit){
imputed <- fit$fit$summary.fitted.values[, c("mean", "0.025quant", "0.975quant")] %>%
cbind(fits$dat$data[,c("Missing",  "Year")]) %>%
filter(imputed_idx)
mix <- imputed %>%
full_join(missing_weights, by = c("Missing")) %>%
mutate(p_mean = p_sites * mean
)  %>% select(Year, Missing, p_mean)
mix_mean <- mix %>%
right_join(years_to_include, by = c("Year", "Missing")) %>%
spread(Missing, p_mean) %>%
mutate(
mean = apply(.[,2:ncol(.)], 1, function(pmeans){
if (sum(!is.na(pmeans)) <= 1){
return(NA)
}   else {
sum(pmeans, na.rm = T)
}
}),
model = fit$model
)
a <- inla.posterior.sample(result = fit$fit, n = 1000)
samples <- map_df(a, function(a){
fits$dat$data[,c("Missing", "Year")] %>%
cbind(prev = exp(a$latent[1:nrow(.)])/(exp(a$latent[1:nrow(.)]) + 1)) %>%
filter(imputed_idx)
}) %>%
full_join(missing_weights, by = "Missing") %>%
mutate(
sampleno = rep(1:1000, each = sum(imputed_idx)),
sample_prev = map2_dbl(mean_size, prev, function(size, prev) {
rbinom(1, size, prev)/size
}),
p_mean = p_sites * sample_prev
) %>%
select(-prev, -n_sites, -p_sites, - sample_prev, -mean_size) %>%
right_join(years_to_include, by = c("Year", "Missing"))
b <- samples %>% spread(Missing, p_mean) %>%
mutate(mean_mix = apply(.[,3:ncol(.)], 1, function(pmeans){
if (sum(!is.na(pmeans)) <= 1){
return(NA)
}   else {
sum(pmeans, na.rm = T)
}
})) %>%
group_by(Year) %>%
nest() %>%
mutate(
cdf = map(data, function(d) {
if (is.na(d$mean_mix[1])) return(NA)
ecdf(d$mean_mix)
}),
lower = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.025)
}),
upper = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.975)
}),
lower2 = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.05)
}),
upper2 = map_dbl(cdf, function(cdfnum){
if (is.na(cdfnum)) return(NA)
quantile(cdfnum, probs = 0.95)
})) %>%
unnest(upper, lower) %>%
select(Year, upper, lower, upper2, lower2) %>%
full_join(mix_mean)
})
estimates <- map_df(fits$fits, function(f){
f$fit$summary.fitted.values[, c("mean", "0.025quant", "0.975quant")] %>%
cbind(fits$dat$data[,c("Missing",  "Year")]) %>%
filter(imputed_idx) %>%
select(Missing, Year, mean) %>%
mutate(model = f$model)
}) %>%
right_join(years_to_include, by = c("Year", "Missing"))
p <- ggplot(fits$dat$data, aes(x = Year)) +
geom_point(aes(y = prev, color = Missing), alpha = 0.5) +
geom_line(data = estimates, aes(y = mean, color = Missing)) +
geom_line(data = predicted, aes(y = mean)) +
facet_wrap(~model) +
geom_ribbon(data = predicted, aes(ymin = lower, ymax = upper),
alpha = 0.2) +
geom_ribbon(data = predicted, aes(ymin = lower2, ymax = upper2),
alpha = 0.2) +
theme_minimal() +
labs(title = "Prediction for new site")
p
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
library(tidyverse)
metadata <- read_csv("../Data/RC_2017-02_metadata.csv",
col_types = "cccciiciiiiic")
library(tidyverse)
metadata <- read_csv("../Data/RC_2017-02_metadata.csv",
col_types = "cccciiciiiiic")
head(metadata)
library(tidyverse)
metadata <- read_csv("../Data/RC_2017-02_features.csv")
knitr::kable(features[1:10,1:20]
knitr::kable(features[1:10,1:20]
knitr::kable(features[1:10,1:20]
)
?kableExtra
install.packages("kableExtra")
?scroll_box
library(kableExtra)
?scroll_box
library(lme4)
?intervals
install.packages(c("backports", "boot", "crayon", "curl", "data.table", "dplyr", "ggrepel", "Matrix", "MCMCglmm", "mgcv", "openNLPdata", "openssl", "psych", "purrr", "Rcpp", "reticulate", "rJava", "rstudioapi", "textshape", "tidyr", "tidyselect", "tidytext"))
library(data.table)
?fread
setwd("~/Box Sync/Fall 2017/SoDA 502/502_Project/Code")
library(readr)
library(dplyr)
library(tidyr)
library(purrr)
library(lubridate)
library(snow)
library(RANN) #for k nearest neighbors
#-------------------------set parameters-------------------------------
args = commandArgs(trailingOnly=TRUE)
if (length(args) > 0) {
# limit data to specific subreddits?
message("Received command line arguments")
subreddits <- args[1] == 1
subset_f <- args[2]
} else {
subreddits <- FALSE
subset_f <- "RC_50a_subset.csv"
}
n_cluster <- 18
file <- "../Data/RC_2017-02"
# path to folder with subsets?
subsetfolder <- "../Output/Subsetting/"
outputfolder <- "../Output/"
options(tibble.print_max = Inf)
tweets <- fread(paste0(subsetfolder, subset_f), select = c("id", "author"))
subset_authors <- subset$author %>% unique
if (subreddits) subset_comments <- subset$id
extract_records <- function(chunk, pos) {
if (subreddits) return(chunk %>% filter(id %in% subset_comments))
return(chunk %>% filter(author %in% subset_authors))
}
features <- do.call("rbind", lapply(1:3, function(idx) {
read_csv_chunked(paste0(file, "_combinedFeaturesSubset", idx, ".csv"),
DataFrameCallback$new(extract_records)) #%>%
# filter(id %in% metadata$id) %>%
# inner_join(metadata, by = c("id", "author", "subreddit"))
}))
feature_cols <- read_csv(paste0(outputfolder, "top_features.csv"))$feature_name
id_cols <- c("id", "author", "subreddit")
features <- features[,c(id_cols, feature_cols)]
library(data.table)
tweets <- fread(paste0(subsetfolder, subset_f), select = c("id", "author"))
tweets <- fread(paste0(subsetfolder, subset_f), select = c("id", "author"))
subset_author <- unique(tweets$author)
tweets <- unique(tweets$id)
subset_author
extract_records <- function(chunk, pos) {
if (subreddits) return(chunk %>% filter(id %in% subset_comments))
return(chunk %>% filter(id %in% tweets))
}
features <- do.call("rbind", lapply(1:3, function(idx) {
read_csv_chunked(paste0(file, "_combinedFeaturesSubset", idx, ".csv"),
DataFrameCallback$new(extract_records)) #%>%
# filter(id %in% metadata$id) %>%
# inner_join(metadata, by = c("id", "author", "subreddit"))
}))
nrow(features)
features_id <- features
extract_records <- function(chunk, pos) {
if (subreddits) return(chunk %>% filter(id %in% subset_comments))
return(chunk %>% filter(author %in% subset_author))
}
features <- do.call("rbind", lapply(1:3, function(idx) {
read_csv_chunked(paste0(file, "_combinedFeaturesSubset", idx, ".csv"),
DataFrameCallback$new(extract_records)) #%>%
# filter(id %in% metadata$id) %>%
# inner_join(metadata, by = c("id", "author", "subreddit"))
}))
nrow(features)
nrow(features_id)
